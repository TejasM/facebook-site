{% load staticfiles %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <title>Benefit Cosmetics</title>
    <link rel="stylesheet" href="/static/css/main.css"/>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script type="text/javascript" src="/static/js/main.js"></script>
</head>
<body>
<div class="loader" style="background: url('/static/images/uploading.gif') no-repeat;"></div>
<div class="content" id="wrap"
     style="width: 1000px; height:1333px; background: url('/static/images/Beneselfies-Locker-Back.png') no-repeat">
    <div style="padding-top: 100px; padding-left: 130px; padding-right: 115px; color: white; font-size: 20px; font-family: arial;">
        <div style="text-align: center">
            <img src="/static/images/Beneselfies-Logo.png"
                 style="width: 240px; height:48px;"/>
        </div>
        <div class="polaroid" id="shopaholic-div">
            <div id="shopaholic" style="display: inline"></div>
        </div>

        <div class="polaroid" id="independent-div">
            <div id="independent" style="display: inline"></div>
        </div>

        <div class="polaroid" id="sporty-div">
            <div id="sporty" style="display: inline"></div>
        </div>


        <div class="polaroid" id="badgal-div">
            <div id="badgal" style="display: inline"></div>
        </div>

        <div class="polaroid" id="flirt-div">
            <div id="flirt" style="display: inline"></div>
        </div>


        <div class="polaroid" id="gorgeous-div">
            <div id="gorgeous" style="display: inline"></div>
        </div>


        <div class="polaroid" id="joker-div">
            <div id="joker" style="display: inline"></div>
        </div>

        <div class="polaroid" id="sexy-div">
            <div id="sexy" style="display: inline"></div>
        </div>

        <div id="fb-root">
        </div>
        <div id="next"
             style="background: url('/static/images/Next-Black.png'); width: 102px; height: 52px; margin-top: 850px; border-radius: 15px; float: right"></div>
    </div>
</div>
<div id="CSPhotoSelector">
    <div class="CSPhotoSelector_dialog">
        <a href="#" id="CSPhotoSelector_buttonClose">x</a>

        <div class="CSPhotoSelector_form">
            <div class="CSPhotoSelector_header">
                <p>Choose from Photos</p>
            </div>
            <label for="filter" style="color: #ffffff">Filter by Tags: </label>
            <input type="text" id="filter">

            <div class="CSPhotoSelector_content CSAlbumSelector_wrapper">
                <p>Browse your albums until you find a picture you want to use</p>

                <div class="CSPhotoSelector_searchContainer CSPhotoSelector_clearfix">
                    <div class="CSPhotoSelector_selectedCountContainer">Select an album</div>
                </div>
                <div class="CSPhotoSelector_photosContainer CSAlbum_container"></div>
            </div>

            <div class="CSPhotoSelector_content CSPhotoSelector_wrapper">
                <p>Select a new photo</p>

                <div class="CSPhotoSelector_searchContainer CSPhotoSelector_clearfix">
                    <div class="CSPhotoSelector_selectedCountContainer"><span
                            class="CSPhotoSelector_selectedPhotoCount">0</span> / <span
                            class="CSPhotoSelector_selectedPhotoCountMax">0</span> photos selected
                    </div>
                    <a href="#" id="CSPhotoSelector_backToAlbums">Back to albums</a>
                </div>
                <div class="CSPhotoSelector_photosContainer CSPhoto_container"></div>
            </div>

            <div id="CSPhotoSelector_loader"></div>


            <div class="CSPhotoSelector_footer CSPhotoSelector_clearfix">
                <a href="#" id="CSPhotoSelector_pagePrev" class="CSPhotoSelector_disabled">Previous</a>
                <a href="#" id="CSPhotoSelector_pageNext">Next</a>

                <div class="CSPhotoSelector_pageNumberContainer">
                    Page <span id="CSPhotoSelector_pageNumber">1</span> / <span
                        id="CSPhotoSelector_pageNumberTotal">1</span>
                </div>
                <a href="#" id="CSPhotoSelector_buttonOK">OK</a>
                <a href="#" id="CSPhotoSelector_buttonCancel">Cancel</a>

            </div>
            <div class="CSPhotoSelector_footer CSPhotoSelector_clearfix">
                    <form action="/addimage/" method="post" enctype="multipart/form-data" id="upload-form">
                        {% csrf_token %}
                        <input type="hidden" value="" name="user_id" id="user_id">
                        <input id="image-upload" type="file" name="image">
                        <button type="submit" id="upload-image">Submit</button>
                    </form>
                </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css"/>
<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="http://connect.facebook.net/en_US/all.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script src="/static/js/image-picker.min.js"></script>
<script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.6.0.min.js"></script>
<script src="http://malsup.github.io/min/jquery.form.min.js"></script>
<link rel="stylesheet" href="/static/css/image-picker.css"/>
<link rel="stylesheet" href="/static/css/selector.css"/>
<script src="/static/js/html2canvas.js"></script>
<script src="/static/js/jquery.autocomplete.js"></script>
<script src="/static/js/selector.js"></script>
<script type="text/javascript">
var options = [];
var tags_all = {};
$(function () {
    var $next = $('#next');
    $next.hide();
    $('div.loader').hide();
    $('#upload-form').ajaxForm({
        success: function (response) {
            var imageObj = new Image();
            imageObj.onload = function () {
                drawImageDraggable(this);
            };
            imageObj.src = response['url'];
            next++;
            $('#next').show();
            $('#upload-div').dialog('close');
        }
    });
    $next.click(function () {
        $('#next').hide();
        html2canvas(document.getElementById('wrap'), {
            onrendered: function (canvas) {
                var dataURL = canvas.toDataURL();
                $.ajax({
                    type: "POST",
                    url: "/upload_custom/",
                    enctype: 'multipart/form-data',
                    data: {'user_id': user_id, 'file': dataURL },
                    success: function (data) {
                        window.location = "/done/" + user_id;
                    }
                });
            }
        });
    });
    var buttonOK = $('#CSPhotoSelector_buttonOK');

    fbphotoSelect = function (id) {
        // if no user/friend id is sent, default to current user
        if (!id) id = 'me';

        callbackAlbumSelected = function (albumId) {
            var album, name;
            album = CSPhotoSelector.getAlbumById(albumId);
            // show album photos
            selector.showPhotoSelector(null, album.id);
        };

        callbackAlbumUnselected = function (albumId) {
        };

        callbackPhotoSelected = function (photoId) {
            buttonOK.show();
        };

        callbackPhotoUnselected = function (photoId) {
            buttonOK.hide();
        };

        callbackSubmit = function (photoId) {
            var photo;
            photo = CSPhotoSelector.getPhotoById(photoId);
            selectPic(photo["picture"])
        };


        // Initialise the Photo Selector with options that will apply to all instances
        CSPhotoSelector.init({debug: true});

        // Create Photo Selector instances
        selector = CSPhotoSelector.newInstance({
            callbackAlbumSelected: callbackAlbumSelected,
            callbackAlbumUnselected: callbackAlbumUnselected,
            callbackPhotoSelected: callbackPhotoSelected,
            callbackPhotoUnselected: callbackPhotoUnselected,
            callbackSubmit: callbackSubmit,
            maxSelection: 1,
            albumsPerPage: 6,
            photosPerPage: 200,
            autoDeselection: true
        });

        // reset and show album selector
        selector.reset();
        selector.showAlbumSelector(id);
    }

});

function filterByTags(suggestion) {
    var $select = $("#select-upload");
    $select.empty();
    $.each(options, function (i) {
        var option = options[i];
        if (option.indexOf(suggestion["value"]) != -1) {
            $select.append(option);
        }
    });
    $select.imagepicker();
}

var next = 0;
var stageCentral = null;
var imageLayer = null;
var image_added = null;

function GetWidth(newHeight, currentWidth, currentHeight) {
    if (currentHeight == 0) return newHeight;
    var aspectRatio = currentWidth / currentHeight;
    return newHeight * aspectRatio;
}

function GetHeight(newWidth, currentWidth, currentHeight) {
    if (currentHeight == 0) return newWidth;
    var aspectRatio = currentWidth / currentHeight;
    return newWidth / aspectRatio;
}

function drawImageDraggable(imageObj) {
    var $filter = $('#filter');
    $filter.val('');
    $filter.change();
    var $polaroids = $(clicked.parentElement).find('.polaroid');
    var i = 0;
    $.each($polaroids, function (index) {
        if ($polaroids[index] == clicked)
            i = index
    });
    var stage = $(clicked).find('canvas')[0];
    var width = 180;
    var height = 200;
    if (imageObj.width / imageObj.height > 0.9) {
        width = 180;
        height = GetHeight(180, imageObj.width, imageObj.height)
    } else {
        height = 200;
        width = GetWidth(200, imageObj.width, imageObj.height)
    }
    image_added = new Kinetic.Image({
        image: imageObj,
        x: stage.width / 2 - width / 2,
        y: stage.height / 2 - height / 2,
        width: width,
        height: height,
        draggable: true
    });

    // add cursor styling
    image_added.on('mouseover', function () {
        document.body.style.cursor = 'pointer';
    });
    image_added.on('mouseout', function () {
        document.body.style.cursor = 'default';
    });
    if (layers[i].children.length > 1) {
        layers[i].children[0].remove();
    }
    layers[i].add(image_added);
    image_added.moveDown();
    layers[i].draw();
}

function drawImage(imageObj, container, i) {
    var stage = new Kinetic.Stage({
        container: container,
        width: 240,
        height: 264
    });
    var layer = new Kinetic.Layer();

    var img = new Kinetic.Image({
        image: imageObj,
        x: stage.getWidth() / 2 - 240 / 2,
        y: stage.getHeight() / 2 - 264 / 2,
        width: 240,
        height: 264
    });

    layer.add(img);
    stage.add(layer);
    layers[i] = layer;

    // Give the inner div's and canvas' the proper width and height values.
    $('#wrap').find('.polaroid div').css({
        height: "100%",
        width: "100%"
    });
    $('#wrap').find('.polaroid canvas').css({
        height: "100%",
        width: "100%"
    });
}

function selectPic(image_url) {
    bringForward(image_url);
}

var photo_urls = [];
var accessToken = null;
var user_id = null;

var album_list = {};


$(function () {
    $('#upload-div').dialog({
        modal: true,
        autoOpen: false,
        width: 700,
        height: 500
    });
    // init the FB JS SDK
    FB.init({
        appId: '151985691672341',                        // App ID from the app dashboard
        cookie: true,
        status: true,                                 // Check Facebook Login status
        xfbml: true                                  // Look for social plugins on the page
    });
});


var current_open = null;
function bringForward(url) {
    var imageObj = new Image();
    imageObj.onload = function () {
        drawImageDraggable(this);
    };
    $.ajax({
        type: "POST",
        url: "/post_pic/",
        async: false,
        data: {
            image: url,
            user_id: user_id
        },
        success: function (data) {
            imageObj.src = data["image"];
        }
    });
    next++;
    $('#next').show();
}

{% comment %}$(function(){
    var count = 0;
    FB.getLoginStatus(function (response) {
        if (response.status == 'connected') {
            try {
                user_id = response.authResponse.userID;
                $("#user_id").val(user_id);
                accessToken = FB.getAuthResponse()['accessToken'];
                var count = 0;
                FB.api('/' + user_id + '/' + 'albums?access_token=' + accessToken + "&limit=500", function (response) {
                    var albums = response["data"];
                    for (var i = 0; i < albums.length; i++) {
                        var albumid = albums[i]["id"];
                        (function (album_name, done) {
                            FB.api('/' + albumid + '/' + 'photos?access_token=' + accessToken + "&limit=500", function (response) {
                                photos = response["data"];
                                album_list[album_name] = [count, photos.length];
                                for (var v = 0; v < photos.length; v++) {
                                    var image_arr = photos[v]["images"];
                                    //POST to server
                                    var tags = "";
                                    try {
                                        var $tags = photos[v]['tags']['data'];
                                        for (var k = 0; k < $tags.length; k++) {
                                            var tag = $tags[k]["name"].replace('"', '').replace(' ', '');
                                            tags += tag;
                                            if (!(tag in tags_all)) {
                                                tags_all[tag.toString()] = true;
                                            }
                                        }
                                    } catch (e) {

                                    }
                                    count++;
                                }
                                if (done) {
                                    var tags_ = [];
                                    $.each(tags_all, function(key, value){
                                        tags_.push({value: key.toString(), data: value});
                                    });
                                    $('#filter').autocomplete({"lookup": tags_, onSelect: filterByTags});
                                    var $select = $('#select-album');
                                    var country = document.getElementById("select-album");
                                    country.options[0].selected = true;
                                    $select.change();
                                }
                            });
                        })(albums[i]["name"], i == (albums.length - 1));
                    }
                });
            }
            catch (e){
            }
        }
        else{
            window.location = "/like";
        }
    });
});{% endcomment %}
</script>
</body>
</html>